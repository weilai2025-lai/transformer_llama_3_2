<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Llama 3.2 3B Architecture Visualization (Accurate)</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
        }

        h1 {
            text-align: center;
            color: #fff;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .info-table {
            max-width: 800px;
            margin: 0 auto 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
        }

        .info-table h4 {
            margin: 0 0 10px 0;
            color: #fff;
        }

        .info-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .info-table td,
        .info-table th {
            padding: 6px 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-align: left;
        }

        .info-table th {
            color: #888;
            font-weight: normal;
        }

        .info-table td:first-child {
            color: #888;
        }

        .weight-table {
            margin-top: 15px;
        }

        .weight-table th {
            background: rgba(255, 255, 255, 0.05);
            color: #4299e1 !important;
            font-weight: 600 !important;
        }

        .weight-dim {
            color: #34d399;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 13px;
        }

        .controls {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        .controls h3 {
            margin-top: 0;
            color: #fff;
        }

        .layer-toggles {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }

        .layer-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            background: #2d3748;
            color: #a0aec0;
        }

        .layer-btn:hover {
            background: #4a5568;
        }

        .layer-btn.active {
            background: #4299e1;
            color: white;
        }

        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .quick-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .quick-btn.all {
            background: #48bb78;
            color: white;
        }

        .quick-btn.none {
            background: #fc8181;
            color: white;
        }

        .quick-btn.first-last {
            background: #9f7aea;
            color: white;
        }

        .quick-btn.first-three {
            background: #ed8936;
            color: white;
        }

        .seq-input-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .seq-input-container label {
            color: #fff;
            font-weight: 500;
        }

        .seq-input {
            width: 80px;
            padding: 8px 12px;
            border: 2px solid #4299e1;
            border-radius: 5px;
            font-size: 14px;
            background: #1a202c;
            color: #fff;
            text-align: center;
        }

        .seq-input:focus {
            outline: none;
            border-color: #63b3ed;
        }

        .seq-hint {
            color: #888;
            font-size: 12px;
        }

        .diagram-container {
            background: #fff;
            border-radius: 10px;
            padding: 20px;
            overflow-x: auto;
            max-width: 100%;
        }

        .mermaid {
            text-align: center;
        }

        .legend {
            max-width: 1000px;
            margin: 20px auto 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
        }

        .legend h4 {
            margin-top: 0;
            color: #fff;
        }

        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            margin-right: 10px;
            flex-shrink: 0;
        }

        .code-block {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 12px;
            line-height: 1.6;
            overflow-x: auto;
        }

        .code-block .comment {
            color: #6b7280;
        }

        .code-block .keyword {
            color: #f472b6;
        }

        .code-block .var {
            color: #60a5fa;
        }

        .code-block .shape {
            color: #34d399;
        }

        .weight-name {
            color: #f472b6;
        }
    </style>
</head>

<body>
    <h1>ü¶ô Llama 3.2 3B Architecture Visualization</h1>
    <p class="subtitle">Accurate tensor shapes and weight matrix dimensions</p>

    <div class="info-table">
        <h4>üìä Model Configuration</h4>
        <table>
            <tr>
                <td>Architecture</td>
                <td><b>Pre-LayerNorm Transformer</b></td>
                <td>vocab_size</td>
                <td><b>128,256</b></td>
            </tr>
            <tr>
                <td>hidden_size</td>
                <td><b>3072</b></td>
                <td>num_hidden_layers</td>
                <td><b>28</b></td>
            </tr>
            <tr>
                <td>num_attention_heads</td>
                <td><b>24</b> (GQA: 8 KV heads)</td>
                <td>head_dim</td>
                <td><b>128</b></td>
            </tr>
            <tr>
                <td>intermediate_size</td>
                <td><b>8192</b> (MLP / SwiGLU)</td>
                <td>rope_theta</td>
                <td><b>500,000</b></td>
            </tr>
        </table>

        <h4 style="margin-top: 20px;">üì¶ Weight Matrix Dimensions (per layer √ó 28)</h4>
        <table class="weight-table">
            <tr>
                <th>Component</th>
                <th>Weight Name</th>
                <th>Shape</th>
                <th>Description</th>
            </tr>
            <tr>
                <td>Embedding</td>
                <td class="weight-name">embed_tokens.weight</td>
                <td class="weight-dim">[128256, 3072]</td>
                <td>Vocabulary ‚Üí Hidden</td>
            </tr>
            <tr>
                <td rowspan="4">Self-Attention</td>
                <td class="weight-name">self_attn.q_proj.weight</td>
                <td class="weight-dim">[3072, 3072]</td>
                <td>Query: 24 heads √ó 128 dim</td>
            </tr>
            <tr>
                <td class="weight-name">self_attn.k_proj.weight</td>
                <td class="weight-dim">[1024, 3072]</td>
                <td>Key: 8 heads √ó 128 dim (GQA)</td>
            </tr>
            <tr>
                <td class="weight-name">self_attn.v_proj.weight</td>
                <td class="weight-dim">[1024, 3072]</td>
                <td>Value: 8 heads √ó 128 dim (GQA)</td>
            </tr>
            <tr>
                <td class="weight-name">self_attn.o_proj.weight</td>
                <td class="weight-dim">[3072, 3072]</td>
                <td>Output projection</td>
            </tr>
            <tr>
                <td rowspan="3">MLP (SwiGLU)</td>
                <td class="weight-name">mlp.gate_proj.weight</td>
                <td class="weight-dim">[8192, 3072]</td>
                <td>Gate projection</td>
            </tr>
            <tr>
                <td class="weight-name">mlp.up_proj.weight</td>
                <td class="weight-dim">[8192, 3072]</td>
                <td>Up projection</td>
            </tr>
            <tr>
                <td class="weight-name">mlp.down_proj.weight</td>
                <td class="weight-dim">[3072, 8192]</td>
                <td>Down projection</td>
            </tr>
            <tr>
                <td rowspan="2">LayerNorm</td>
                <td class="weight-name">input_layernorm.weight</td>
                <td class="weight-dim">[3072]</td>
                <td>RMSNorm (no bias)</td>
            </tr>
            <tr>
                <td class="weight-name">post_attention_layernorm.weight</td>
                <td class="weight-dim">[3072]</td>
                <td>RMSNorm (no bias)</td>
            </tr>
            <tr>
                <td>Final Norm</td>
                <td class="weight-name">model.norm.weight</td>
                <td class="weight-dim">[3072]</td>
                <td>Final RMSNorm</td>
            </tr>
            <tr>
                <td>LM Head</td>
                <td class="weight-name">lm_head.weight</td>
                <td class="weight-dim">[128256, 3072]</td>
                <td>Hidden ‚Üí Vocabulary</td>
            </tr>
        </table>
    </div>

    <div class="controls">
        <h3>üéõÔ∏è Configuration</h3>

        <div class="seq-input-container">
            <label for="seqLen">Sequence Length (tokens):</label>
            <input type="number" id="seqLen" class="seq-input" value="3" min="1" max="8192">
            <span class="seq-hint">e.g., "I love you" = 3 tokens</span>
        </div>

        <div style="margin-top: 15px;">
            <label style="color: #fff; font-weight: 500;">Select Layers to Expand:</label>
        </div>
        <div class="layer-toggles" id="layerToggles" style="margin-top: 8px;"></div>
        <div class="quick-actions">
            <button class="quick-btn all" onclick="selectAll()">Expand All</button>
            <button class="quick-btn none" onclick="selectNone()">Collapse All</button>
            <button class="quick-btn first-last" onclick="selectFirstLast()">L0 + L27</button>
            <button class="quick-btn first-three" onclick="selectFirstThree()">First 3</button>
        </div>
    </div>

    <div class="diagram-container">
        <div id="diagram"></div>
    </div>

    <div class="legend">
        <h4>üìã Legend + Tensor Shape Reference</h4>
        <div class="legend-grid">
            <div class="legend-item">
                <div class="legend-color" style="background: #e1f5fe;"></div>
                <span>üîÑ RoPE - Rotary Position Embedding</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #fff3e0;"></div>
                <span>‚ö° Attention Score Computation</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #f3e5f5;"></div>
                <span>SiLU - SwiGLU Activation</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #c8e6c9;"></div>
                <span>‚äï Residual Add Node</span>
            </div>
        </div>
        <div class="code-block" id="shapeReference">
            <!-- Dynamic content will be inserted here -->
        </div>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            flowchart: { useMaxWidth: true, htmlLabels: true, curve: 'basis' },
            securityLevel: 'loose'
        });

        let selectedLayers = new Set([0]);
        let seqLen = 3;

        document.getElementById('seqLen').addEventListener('input', function (e) {
            const val = parseInt(e.target.value);
            if (val >= 1 && val <= 8192) {
                seqLen = val;
                updateShapeReference();
                renderDiagram();
            }
        });

        function updateShapeReference() {
            const s = seqLen;
            const ref = document.getElementById('shapeReference');
            ref.innerHTML = `
                <span class="comment"># Complete Forward Pass for seq_len = ${s}</span><br><br>
                <span class="comment">## Embedding</span><br>
                input_ids: <span class="shape">[${s}]</span><br>
                X = embed_tokens[input_ids] ‚Üí <span class="shape">[${s}, 3072]</span><br><br>
                <span class="comment">## Per Layer (√ó28)</span><br>
                residual = X<br>
                X_norm = RMSNorm(X) ‚Üí <span class="shape">[${s}, 3072]</span><br><br>
                <span class="comment"># Q/K/V Projections: X_norm @ W.T</span><br>
                Q = X_norm @ <span class="weight-name">Wq.T</span> ‚Üí <span class="shape">[${s}, 3072]</span> ‚Üí reshape ‚Üí <span class="shape">[${s}, 24, 128]</span><br>
                K = X_norm @ <span class="weight-name">Wk.T</span> ‚Üí <span class="shape">[${s}, 1024]</span> ‚Üí reshape ‚Üí <span class="shape">[${s}, 8, 128]</span><br>
                V = X_norm @ <span class="weight-name">Wv.T</span> ‚Üí <span class="shape">[${s}, 1024]</span> ‚Üí reshape ‚Üí <span class="shape">[${s}, 8, 128]</span><br><br>
                <span class="comment"># RoPE (only Q and K)</span><br>
                Q_rot, K_rot = RoPE(Q, K)<br><br>
                <span class="comment"># Attention (per head, GQA: 3 Q heads share 1 KV head)</span><br>
                score = Q @ K.T / ‚àö128 ‚Üí <span class="shape">[${s}, ${s}]</span> per head<br>
                attn = softmax(score) ‚Üí <span class="shape">[${s}, ${s}]</span><br>
                out = attn @ V ‚Üí <span class="shape">[${s}, 128]</span> per head<br>
                out_concat = concat(24 heads) ‚Üí <span class="shape">[${s}, 3072]</span><br>
                out = out_concat @ <span class="weight-name">Wo.T</span> ‚Üí <span class="shape">[${s}, 3072]</span><br><br>
                <span class="comment"># Residual Add #1</span><br>
                X = residual + out ‚Üí <span class="shape">[${s}, 3072]</span><br><br>
                <span class="comment"># MLP (SwiGLU)</span><br>
                residual = X<br>
                X_norm = RMSNorm(X)<br>
                gate = X_norm @ <span class="weight-name">Wgate.T</span> ‚Üí <span class="shape">[${s}, 8192]</span><br>
                up = X_norm @ <span class="weight-name">Wup.T</span> ‚Üí <span class="shape">[${s}, 8192]</span><br>
                hidden = SiLU(gate) √ó up ‚Üí <span class="shape">[${s}, 8192]</span><br>
                down = hidden @ <span class="weight-name">Wdown.T</span> ‚Üí <span class="shape">[${s}, 3072]</span><br><br>
                <span class="comment"># Residual Add #2</span><br>
                X = residual + down ‚Üí <span class="shape">[${s}, 3072]</span><br><br>
                <span class="comment">## Output</span><br>
                X = RMSNorm(X) ‚Üí <span class="shape">[${s}, 3072]</span><br>
                logits = X @ <span class="weight-name">lm_head.T</span> ‚Üí <span class="shape">[${s}, 128256]</span>
            `;
        }

        function createLayerButtons() {
            const container = document.getElementById('layerToggles');
            for (let i = 0; i < 28; i++) {
                const btn = document.createElement('button');
                btn.className = 'layer-btn' + (selectedLayers.has(i) ? ' active' : '');
                btn.textContent = `L${i}`;
                btn.onclick = () => toggleLayer(i, btn);
                container.appendChild(btn);
            }
        }

        function toggleLayer(index, btn) {
            if (selectedLayers.has(index)) {
                selectedLayers.delete(index);
                btn.classList.remove('active');
            } else {
                selectedLayers.add(index);
                btn.classList.add('active');
            }
            renderDiagram();
        }

        function selectAll() {
            selectedLayers = new Set([...Array(28).keys()]);
            document.querySelectorAll('.layer-btn').forEach(btn => btn.classList.add('active'));
            renderDiagram();
        }

        function selectNone() {
            selectedLayers = new Set();
            document.querySelectorAll('.layer-btn').forEach(btn => btn.classList.remove('active'));
            renderDiagram();
        }

        function selectFirstLast() {
            selectedLayers = new Set([0, 27]);
            document.querySelectorAll('.layer-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === 0 || i === 27);
            });
            renderDiagram();
        }

        function selectFirstThree() {
            selectedLayers = new Set([0, 1, 2]);
            document.querySelectorAll('.layer-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i < 3);
            });
            renderDiagram();
        }

        function generateLayerCode(i, isLast) {
            const s = seqLen;
            const layerName = isLast ? `Layer ${i} Final` : `Layer ${i}`;
            return `
    subgraph L${i}["üì¶ ${layerName}"]
        L${i}_IN(["X: [${s}, 3072]"])
        
        L${i}_RES1{{"residual"}}
        L${i}_NORM1["RMSNorm<br/>[${s}, 3072]"]
        
        subgraph L${i}_ATTN["Self-Attention (GQA)"]
            L${i}_Q["Q = X @ Wq.T<br/>Wq: [3072, 3072]<br/>‚Üí [${s}, 24, 128]"]
            L${i}_K["K = X @ Wk.T<br/>Wk: [1024, 3072]<br/>‚Üí [${s}, 8, 128]"]
            L${i}_V["V = X @ Wv.T<br/>Wv: [1024, 3072]<br/>‚Üí [${s}, 8, 128]"]
            L${i}_ROPE["üîÑ RoPE<br/>Q,K only"]
            L${i}_SCORE["‚ö° Q @ K.T / ‚àö128<br/>[${s}, ${s}] per head"]
            L${i}_MATMUL["softmax @ V<br/>[${s}, 128] per head"]
            L${i}_O["concat @ Wo.T<br/>Wo: [3072, 3072]<br/>‚Üí [${s}, 3072]"]
        end
        
        L${i}_ADD1((("‚äï")))
        
        L${i}_RES2{{"residual"}}
        L${i}_NORM2["RMSNorm<br/>[${s}, 3072]"]
        
        subgraph L${i}_MLP["MLP (SwiGLU)"]
            L${i}_GATE["gate = X @ Wgate.T<br/>Wgate: [8192, 3072]<br/>‚Üí [${s}, 8192]"]
            L${i}_UP["up = X @ Wup.T<br/>Wup: [8192, 3072]<br/>‚Üí [${s}, 8192]"]
            L${i}_SILU["SiLU(gate) √ó up<br/>[${s}, 8192]"]
            L${i}_DOWN["down = h @ Wdown.T<br/>Wdown: [3072, 8192]<br/>‚Üí [${s}, 3072]"]
        end
        
        L${i}_ADD2((("‚äï")))
        
        L${i}_OUT(["out: [${s}, 3072]"])
    end

    L${i}_IN --> L${i}_RES1
    L${i}_IN --> L${i}_NORM1
    L${i}_NORM1 --> L${i}_Q
    L${i}_NORM1 --> L${i}_K
    L${i}_NORM1 --> L${i}_V
    L${i}_Q --> L${i}_ROPE
    L${i}_K --> L${i}_ROPE
    L${i}_ROPE --> L${i}_SCORE
    L${i}_V --> L${i}_MATMUL
    L${i}_SCORE --> L${i}_MATMUL
    L${i}_MATMUL --> L${i}_O
    L${i}_RES1 --> L${i}_ADD1
    L${i}_O --> L${i}_ADD1
    L${i}_ADD1 --> L${i}_RES2
    L${i}_ADD1 --> L${i}_NORM2
    L${i}_NORM2 --> L${i}_GATE
    L${i}_NORM2 --> L${i}_UP
    L${i}_GATE --> L${i}_SILU
    L${i}_UP --> L${i}_SILU
    L${i}_SILU --> L${i}_DOWN
    L${i}_RES2 --> L${i}_ADD2
    L${i}_DOWN --> L${i}_ADD2
    L${i}_ADD2 --> L${i}_OUT

    style L${i}_ROPE fill:#e1f5fe,stroke:#0288d1
    style L${i}_SCORE fill:#fff3e0,stroke:#f57c00
    style L${i}_MATMUL fill:#fff3e0,stroke:#f57c00
    style L${i}_SILU fill:#f3e5f5,stroke:#7b1fa2
    style L${i}_ADD1 fill:#c8e6c9,stroke:#388e3c
    style L${i}_ADD2 fill:#c8e6c9,stroke:#388e3c
    style L${i}_RES1 fill:#fff9c4,stroke:#f9a825
    style L${i}_RES2 fill:#fff9c4,stroke:#f9a825
`;
        }

        async function renderDiagram() {
            const sortedLayers = [...selectedLayers].sort((a, b) => a - b);
            const s = seqLen;

            let code = `graph TD
    subgraph Input["üîπ Input"]
        A["input_ids<br/>[${s}]"]
    end

    subgraph Embedding["üîπ Embedding"]
        B["embed_tokens<br/>Weight: [128256, 3072]<br/>[${s}] ‚Üí [${s}, 3072]"]
    end

    A --> B
`;

            if (sortedLayers.length === 0) {
                code += `
    B -.->|"skip 28 layers"| G

    subgraph Output["üîπ Output"]
        G["Final RMSNorm<br/>[${s}, 3072]"]
        H["lm_head<br/>Weight: [128256, 3072]<br/>[${s}, 3072] ‚Üí [${s}, 128256]"]
        I["logits"]
    end

    G --> H --> I
`;
            } else {
                let lastIndex = -1;

                for (let i = 0; i < sortedLayers.length; i++) {
                    const layerIndex = sortedLayers[i];
                    const isLast = layerIndex === 27;

                    code += generateLayerCode(layerIndex, isLast);

                    if (lastIndex === -1) {
                        if (layerIndex > 0) {
                            code += `    B -.->|"skip ${layerIndex}"| L${layerIndex}_IN\n`;
                        } else {
                            code += `    B --> L${layerIndex}_IN\n`;
                        }
                    } else {
                        const skipped = layerIndex - lastIndex - 1;
                        if (skipped > 0) {
                            code += `    L${lastIndex}_OUT -.->|"skip ${skipped}"| L${layerIndex}_IN\n`;
                        } else {
                            code += `    L${lastIndex}_OUT --> L${layerIndex}_IN\n`;
                        }
                    }

                    lastIndex = layerIndex;
                }

                const lastSelected = sortedLayers[sortedLayers.length - 1];
                const remaining = 27 - lastSelected;

                if (remaining > 0) {
                    code += `    L${lastSelected}_OUT -.->|"skip ${remaining}"| G\n`;
                } else {
                    code += `    L${lastSelected}_OUT --> G\n`;
                }

                code += `
    subgraph Output["üîπ Output"]
        G["Final RMSNorm<br/>[${s}, 3072]"]
        H["lm_head<br/>Weight: [128256, 3072]<br/>[${s}, 3072] ‚Üí [${s}, 128256]"]
        I["logits"]
    end

    G --> H --> I
`;
            }

            const container = document.getElementById('diagram');
            container.innerHTML = '<div class="mermaid">' + code + '</div>';

            await mermaid.run();
        }

        createLayerButtons();
        updateShapeReference();
        renderDiagram();
    </script>
</body>

</html>